name: Integration Tests

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'backend/restaurant-service/**'
      - 'backend/order-service/**'
      - 'backend/payment-service/**'
      - 'backend/auth-service/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'backend/restaurant-service/**'
      - 'backend/order-service/**'
      - 'backend/payment-service/**'
      - 'backend/auth-service/**'
  workflow_dispatch:

jobs:
  restaurant-service-tests:
    name: Restaurant Service Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: Restaurant
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 40s

    strategy:
      matrix:
        node-version: [18.x]
      fail-fast: false

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîß Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          # Cache disabled for monorepo - npm ci is fast enough
          # cache: 'npm'
          # cache-dependency-path: 'backend/restaurant-service/package-lock.json'

      - name: üì¶ Install Dependencies
        working-directory: ./backend/restaurant-service
        run: npm ci

      - name: ‚è≥ Wait for MongoDB to be Ready
        run: |
          echo "‚è≥ Waiting for MongoDB to be ready..."
          # The service container already has health checks configured
          # Just give it a few extra seconds to be safe
          sleep 5
          
          # Test connection using Node.js (already installed)
          echo "üîç Testing MongoDB connection with Node.js..."
          node -e "
            const { MongoClient } = require('mongodb');
            const client = new MongoClient('mongodb://localhost:27017');
            client.connect()
              .then(() => {
                console.log('‚úÖ MongoDB connection successful!');
                return client.db('Restaurant').admin().ping();
              })
              .then(() => {
                console.log('‚úÖ MongoDB ping successful!');
                return client.close();
              })
              .catch(err => {
                console.error('‚ùå MongoDB connection failed:', err.message);
                process.exit(1);
              });
          "
        working-directory: ./backend/restaurant-service

      - name: üß™ Run Integration Tests
        working-directory: ./backend/restaurant-service
        env:
          MONGO_URI: mongodb://localhost:27017/Restaurant
          JWT_SECRET: test_secret_key_for_integration_tests_ci_cd
          PORT: 5002
          NODE_ENV: test
        run: |
          echo "üöÄ Running Restaurant Service Integration Tests..."
          echo "Environment Configuration:"
          echo "  - MONGO_URI: $MONGO_URI"
          echo "  - JWT_SECRET: [HIDDEN]"
          echo "  - PORT: $PORT"
          echo "  - NODE_ENV: $NODE_ENV"
          echo ""
          npm test -- test/integration --verbose

      - name: üìä Generate Test Report
        if: always()
        working-directory: ./backend/restaurant-service
        run: |
          echo "üìä Restaurant Service Test Results Summary:"
          echo "========================================"
          if [ -f test-results.json ]; then
            cat test-results.json
          else
            echo "‚ÑπÔ∏è No test results file found"
          fi

      - name: üìà Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: restaurant-service-test-results-node-${{ matrix.node-version }}
          path: |
            backend/restaurant-service/coverage/
            backend/restaurant-service/*.log
          retention-days: 7

      - name: ‚úÖ Integration Tests Summary
        if: success()
        run: |
          echo "‚úÖ All restaurant service integration tests passed successfully!"
          echo ""
          echo "üìã Tests Validated (42 tests):"
          echo "  ‚úì RISK-01: JWT Secret Mismatch (7 tests)"
          echo "  ‚úì RISK-02: String-Based Foreign Keys (6 tests)"
          echo "  ‚úì RISK-03: Restaurant Availability Not Validated (7 tests)"
          echo "  ‚úì RISK-04: FoodItem Availability Not Validated (8 tests)"
          echo "  ‚úì RISK-05: Price Manipulation (8 tests)"
          echo "  ‚úì RISK-06: Payment-Order Status Sync Failure (7 tests)"

      - name: ‚ùå Integration Tests Failed
        if: failure()
        run: |
          echo "‚ùå Restaurant service integration tests failed!"
          echo "Please check the logs above for details."
          exit 1

  payment-service-tests:
    name: Payment Service Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: Restaurant
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 40s

    strategy:
      matrix:
        node-version: [18.x]
      fail-fast: false

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîß Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          # Cache disabled for monorepo - npm ci is fast enough
          # cache: 'npm'
          # cache-dependency-path: 'backend/payment-service/package-lock.json'

      - name: üì¶ Install Dependencies
        working-directory: ./backend/payment-service
        run: npm ci

      - name: ‚è≥ Wait for MongoDB to be Ready
        run: |
          echo "‚è≥ Waiting for MongoDB to be ready..."
          sleep 5
          
          echo "üîç Testing MongoDB connection..."
          node -e "
            const { MongoClient } = require('mongodb');
            const client = new MongoClient('mongodb://localhost:27017');
            client.connect()
              .then(() => {
                console.log('‚úÖ MongoDB connection successful!');
                return client.db('Restaurant').admin().ping();
              })
              .then(() => {
                console.log('‚úÖ MongoDB ping successful!');
                return client.close();
              })
              .catch(err => {
                console.error('‚ùå MongoDB connection failed:', err.message);
                process.exit(1);
              });
          "
        working-directory: ./backend/payment-service

      - name: üß™ Run Payment Service Integration Tests
        working-directory: ./backend/payment-service
        env:
          MONGO_URI: mongodb://localhost:27017/Restaurant
          STRIPE_SECRET_KEY: sk_test_mock_key_for_testing
          STRIPE_WEBHOOK_SECRET: whsec_test_mock_webhook_secret
          JWT_SECRET: test_secret_key_for_integration_tests_ci_cd
          PORT: 5003
          NODE_ENV: test
        run: |
          echo "üöÄ Running Payment Service Integration Tests..."
          echo "Environment Configuration:"
          echo "  - MONGO_URI: $MONGO_URI"
          echo "  - PORT: $PORT"
          echo "  - NODE_ENV: $NODE_ENV"
          echo ""
          echo "‚ö†Ô∏è Note: Tests run serially with --runInBand to prevent database race conditions"
          echo ""
          npm run test:integration -- --verbose

      - name: üìä Generate Test Report
        if: always()
        working-directory: ./backend/payment-service
        run: |
          echo "üìä Payment Service Test Results Summary:"
          echo "========================================"
          echo "Tests completed. Check logs above for details."

      - name: üìà Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: payment-service-test-results-node-${{ matrix.node-version }}
          path: |
            backend/payment-service/coverage/
            backend/payment-service/*.log
          retention-days: 7

      - name: ‚úÖ Payment Service Tests Summary
        if: success()
        run: |
          echo "‚úÖ All payment service integration tests passed successfully!"
          echo ""
          echo "üìã Security Risks Validated (51 tests):"
          echo "  ‚úì RISK-PAYMENT-01: Client Secret Leakage (6 tests)"
          echo "  ‚úì RISK-PAYMENT-02: Duplicate OrderId Race Conditions (8 tests)"
          echo "  ‚úì RISK-PAYMENT-03: Price Manipulation (10 tests)"
          echo "  ‚úì RISK-PAYMENT-04: Webhook Signature Verification (10 tests)"
          echo "  ‚úì RISK-PAYMENT-09: Sensitive Data Logging (10 tests)"
          echo "  ‚úì RISK-PAYMENT-10: No Idempotency Key (10 tests)"

      - name: ‚ùå Payment Service Tests Failed
        if: failure()
        run: |
          echo "‚ùå Payment service integration tests failed!"
          echo "Please check the logs above for details."
          exit 1

  order-service-tests:
    name: Order Service Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: Order
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 40s

    strategy:
      matrix:
        node-version: [18.x]
      fail-fast: false

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîß Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: üì¶ Install Dependencies
        working-directory: ./backend/order-service
        run: npm ci

      - name: ‚è≥ Wait for MongoDB to be Ready
        run: |
          echo "‚è≥ Waiting for MongoDB to be ready..."
          sleep 5
          
          echo "üîç Testing MongoDB connection..."
          node -e "
            const { MongoClient } = require('mongodb');
            const client = new MongoClient('mongodb://localhost:27017');
            client.connect()
              .then(() => {
                console.log('‚úÖ MongoDB connection successful!');
                return client.db('Order').admin().ping();
              })
              .then(() => {
                console.log('‚úÖ MongoDB ping successful!');
                return client.close();
              })
              .catch(err => {
                console.error('‚ùå MongoDB connection failed:', err.message);
                process.exit(1);
              });
          "
        working-directory: ./backend/order-service

      - name: üß™ Run Order Service Integration Tests
        working-directory: ./backend/order-service
        env:
          MONGO_URI: mongodb://localhost:27017/Order
          JWT_SECRET: test_secret_key_for_integration_tests_ci_cd
          PORT: 5001
          NODE_ENV: test
        run: |
          echo "üöÄ Running Order Service Integration Tests..."
          echo "Environment Configuration:"
          echo "  - MONGO_URI: $MONGO_URI"
          echo "  - JWT_SECRET: [HIDDEN]"
          echo "  - PORT: $PORT"
          echo "  - NODE_ENV: $NODE_ENV"
          echo ""
          echo "‚ö†Ô∏è Note: Tests run serially with --runInBand to prevent database race conditions"
          echo ""
          npm run test:integration

      - name: üìä Generate Test Report
        if: always()
        working-directory: ./backend/order-service
        run: |
          echo "üìä Order Service Test Results Summary:"
          echo "========================================"
          echo "Tests completed. Check logs above for details."

      - name: üìà Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: order-service-test-results-node-${{ matrix.node-version }}
          path: |
            backend/order-service/coverage/
            backend/order-service/*.log
            backend/order-service/test-*.txt
          retention-days: 7

      - name: ‚úÖ Order Service Tests Summary
        if: success()
        run: |
          echo "‚úÖ All order service integration tests passed successfully!"
          echo ""
          echo "üìã Security Risks Validated (72 tests):"
          echo "  ‚úì RISK-01: JWT Secret Mismatch Between Services (8 tests)"
          echo "  ‚úì RISK-03: Ghost References (No FK Validation) (12 tests)"
          echo "  ‚úì RISK-05: WebSocket Authentication Bypass (13 tests)"
          echo "  ‚úì RISK-07: Payment-Order Status Not Synced (8 tests)"
          echo "  ‚úì RISK-08: MongoDB Isolation Not Enforced (15 tests)"
          echo "  ‚úì RISK-10: CORS Wildcard Allows Any Origin (18 tests)"

      - name: ‚ùå Order Service Tests Failed
        if: failure()
        run: |
          echo "‚ùå Order service integration tests failed!"
          echo "Please check the logs above for details."
          exit 1

  security-analysis:
    name: Security Risk Analysis
    runs-on: ubuntu-latest
    needs: [restaurant-service-tests, payment-service-tests, order-service-tests]
    if: always()
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Analyze Integration Test Results
        run: |
          echo "üîí Security Risk Analysis Report"
          echo "=================================="
          echo ""
          echo "üìå Critical Risks Validated:"
          echo ""
          echo "üî¥ HIGH PRIORITY - Restaurant Service:"
          echo "  ‚Ä¢ RISK-05: Price Manipulation (Client-Controlled Pricing)"
          echo "  ‚Ä¢ RISK-06: Payment-Order Status Sync Failure"
          echo "  ‚Ä¢ RISK-01: JWT Secret Mismatch Across Services"
          echo ""
          echo "üî¥ HIGH PRIORITY - Payment Service:"
          echo "  ‚Ä¢ RISK-PAYMENT-01: Client Secret Leakage in Database"
          echo "  ‚Ä¢ RISK-PAYMENT-03: Price Manipulation via Client Amount"
          echo "  ‚Ä¢ RISK-PAYMENT-04: Webhook Signature Verification Bypass"
          echo "  ‚Ä¢ RISK-PAYMENT-10: Missing Idempotency Keys"
          echo ""
          echo "ÔøΩ HIGH PRIORITY - Order Service:"
          echo "  ‚Ä¢ RISK-01: JWT Secret Mismatch Between Services"
          echo "  ‚Ä¢ RISK-07: Payment-Order Status Not Synchronized"
          echo "  ‚Ä¢ RISK-10: CORS Wildcard Allows Any Origin"
          echo ""
          echo "ÔøΩüü° MEDIUM PRIORITY:"
          echo "  ‚Ä¢ RISK-03: Restaurant Availability Not Validated"
          echo "  ‚Ä¢ RISK-04: FoodItem Availability Not Validated"
          echo "  ‚Ä¢ RISK-PAYMENT-02: Duplicate OrderId Race Conditions"
          echo "  ‚Ä¢ RISK-PAYMENT-09: Sensitive Data in Logs"
          echo "  ‚Ä¢ RISK-03 (Order): Ghost References (No FK Validation)"
          echo "  ‚Ä¢ RISK-08: MongoDB Isolation Not Enforced"
          echo ""
          echo "üü¢ LOW PRIORITY:"
          echo "  ‚Ä¢ RISK-02: String-Based Foreign Keys"
          echo "  ‚Ä¢ RISK-05 (Order): WebSocket Authentication Documentation"
          echo ""
          echo "üí° Recommendation: Address HIGH priority risks immediately"
          echo ""
          echo "üìä Total Tests Executed: 165 integration tests"
          echo "  - Restaurant Service: 42 tests"
          echo "  - Payment Service: 51 tests"
          echo "  - Order Service: 72 tests"

      - name: üìù Create Test Failure Summary
        if: needs.restaurant-service-tests.result == 'failure' || needs.payment-service-tests.result == 'failure' || needs.order-service-tests.result == 'failure'
        run: |
          echo "## üö® Integration Test Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ùå Failed Tests" >> $GITHUB_STEP_SUMMARY
          echo "One or more integration tests have failed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.restaurant-service-tests.result }}" == "failure" ]; then
            echo "- ‚ùå Restaurant Service Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.payment-service-tests.result }}" == "failure" ]; then
            echo "- ‚ùå Payment Service Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.order-service-tests.result }}" == "failure" ]; then
            echo "- ‚ùå Order Service Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Action Required" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the workflow logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Investigate the failing test cases" >> $GITHUB_STEP_SUMMARY
          echo "3. Fix the issues in the codebase" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-run the tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üß™ Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "**Restaurant Service:**" >> $GITHUB_STEP_SUMMARY
          echo "- JWT Secret Mismatch" >> $GITHUB_STEP_SUMMARY
          echo "- String-Based Foreign Keys" >> $GITHUB_STEP_SUMMARY
          echo "- Restaurant Availability Validation" >> $GITHUB_STEP_SUMMARY
          echo "- FoodItem Availability Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Price Manipulation Prevention" >> $GITHUB_STEP_SUMMARY
          echo "- Payment-Order Status Synchronization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Payment Service:**" >> $GITHUB_STEP_SUMMARY
          echo "- Client Secret Leakage" >> $GITHUB_STEP_SUMMARY
          echo "- Duplicate OrderId Race Conditions" >> $GITHUB_STEP_SUMMARY
          echo "- Price Manipulation" >> $GITHUB_STEP_SUMMARY
          echo "- Webhook Signature Verification" >> $GITHUB_STEP_SUMMARY
          echo "- Sensitive Data Logging" >> $GITHUB_STEP_SUMMARY
          echo "- Missing Idempotency Keys" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Order Service:**" >> $GITHUB_STEP_SUMMARY
          echo "- JWT Secret Mismatch Between Services" >> $GITHUB_STEP_SUMMARY
          echo "- Ghost References (No FK Validation)" >> $GITHUB_STEP_SUMMARY
          echo "- WebSocket Authentication Bypass" >> $GITHUB_STEP_SUMMARY
          echo "- Payment-Order Status Not Synced" >> $GITHUB_STEP_SUMMARY
          echo "- MongoDB Isolation Not Enforced" >> $GITHUB_STEP_SUMMARY
          echo "- CORS Wildcard Allows Any Origin" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ Create Success Summary
        if: needs.restaurant-service-tests.result == 'success' && needs.payment-service-tests.result == 'success' && needs.order-service-tests.result == 'success'
        run: |
          echo "## ‚úÖ All Integration Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: 165 integration tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Restaurant Service (42 tests):" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-01: JWT Secret Mismatch (7 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-02: String-Based Foreign Keys (6 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-03: Restaurant Availability (7 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-04: FoodItem Availability (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-05: Price Manipulation (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-06: Payment-Order Status Sync (7 tests)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Payment Service (51 tests):" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-PAYMENT-01: Client Secret Leakage (6 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-PAYMENT-02: Duplicate OrderId Race (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-PAYMENT-03: Price Manipulation (10 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-PAYMENT-04: Webhook Signature (10 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-PAYMENT-09: Sensitive Logging (10 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-PAYMENT-10: No Idempotency Key (10 tests)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Order Service (72 tests):" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-01: JWT Secret Mismatch (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-03: Ghost References (12 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-05: WebSocket Auth Bypass (13 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-07: Payment-Order Status (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-08: MongoDB Isolation (15 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì RISK-10: CORS Wildcard (18 tests)" >> $GITHUB_STEP_SUMMARY

  notification:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [restaurant-service-tests, payment-service-tests, order-service-tests]
    if: always()
    
    steps:
      - name: ‚úÖ Success Notification
        if: needs.restaurant-service-tests.result == 'success' && needs.payment-service-tests.result == 'success' && needs.order-service-tests.result == 'success'
        run: |
          echo "‚úÖ All integration tests passed!"
          echo "   - Restaurant Service: 42 tests"
          echo "   - Payment Service: 51 tests"
          echo "   - Order Service: 72 tests"
          echo "   - Total: 165 tests"
          echo "üéâ Great job! The codebase maintains expected behavior for all known vulnerabilities."

      - name: ‚ùå Failure Notification
        if: needs.restaurant-service-tests.result == 'failure' || needs.payment-service-tests.result == 'failure' || needs.order-service-tests.result == 'failure'
        run: |
          echo "‚ùå One or more integration test suites failed!"
          if [ "${{ needs.restaurant-service-tests.result }}" == "failure" ]; then
            echo "   - Restaurant Service: FAILED"
          fi
          if [ "${{ needs.payment-service-tests.result }}" == "failure" ]; then
            echo "   - Payment Service: FAILED"
          fi
          if [ "${{ needs.order-service-tests.result }}" == "failure" ]; then
            echo "   - Order Service: FAILED"
          fi
          echo "üîç Please review the test logs and fix the issues."
          echo "‚ö†Ô∏è This may indicate new changes that affect existing vulnerabilities."
