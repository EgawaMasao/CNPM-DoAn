name: Integration Tests

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'backend/restaurant-service/**'
      - 'backend/order-service/**'
      - 'backend/payment-service/**'
      - 'backend/auth-service/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'backend/restaurant-service/**'
      - 'backend/order-service/**'
      - 'backend/payment-service/**'
      - 'backend/auth-service/**'
  workflow_dispatch:

jobs:
  restaurant-service-tests:
    name: Restaurant Service Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: Restaurant
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 40s

    strategy:
      matrix:
        node-version: [18.x]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          # Cache disabled for monorepo - npm ci is fast enough
          # cache: 'npm'
          # cache-dependency-path: 'backend/restaurant-service/package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        working-directory: ./backend/restaurant-service
        run: npm ci

      - name: â³ Wait for MongoDB to be Ready
        run: |
          echo "â³ Waiting for MongoDB to be ready..."
          # The service container already has health checks configured
          # Just give it a few extra seconds to be safe
          sleep 5
          
          # Test connection using Node.js (already installed)
          echo "ğŸ” Testing MongoDB connection with Node.js..."
          node -e "
            const { MongoClient } = require('mongodb');
            const client = new MongoClient('mongodb://localhost:27017');
            client.connect()
              .then(() => {
                console.log('âœ… MongoDB connection successful!');
                return client.db('Restaurant').admin().ping();
              })
              .then(() => {
                console.log('âœ… MongoDB ping successful!');
                return client.close();
              })
              .catch(err => {
                console.error('âŒ MongoDB connection failed:', err.message);
                process.exit(1);
              });
          "
        working-directory: ./backend/restaurant-service

      - name: ğŸ§ª Run Integration Tests
        working-directory: ./backend/restaurant-service
        env:
          MONGO_URI: mongodb://localhost:27017/Restaurant
          JWT_SECRET: test_secret_key_for_integration_tests_ci_cd
          PORT: 5002
          NODE_ENV: test
        run: |
          echo "ğŸš€ Running Restaurant Service Integration Tests..."
          echo "Environment Configuration:"
          echo "  - MONGO_URI: $MONGO_URI"
          echo "  - JWT_SECRET: [HIDDEN]"
          echo "  - PORT: $PORT"
          echo "  - NODE_ENV: $NODE_ENV"
          echo ""
          npm test -- test/integration --verbose

      - name: ğŸ“Š Generate Test Report
        if: always()
        working-directory: ./backend/restaurant-service
        run: |
          echo "ğŸ“Š Restaurant Service Test Results Summary:"
          echo "========================================"
          if [ -f test-results.json ]; then
            cat test-results.json
          else
            echo "â„¹ï¸ No test results file found"
          fi

      - name: ğŸ“ˆ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: restaurant-service-test-results-node-${{ matrix.node-version }}
          path: |
            backend/restaurant-service/coverage/
            backend/restaurant-service/*.log
          retention-days: 7

      - name: âœ… Integration Tests Summary
        if: success()
        run: |
          echo "âœ… All restaurant service integration tests passed successfully!"
          echo ""
          echo "ğŸ“‹ Tests Validated (42 tests):"
          echo "  âœ“ RISK-01: JWT Secret Mismatch (7 tests)"
          echo "  âœ“ RISK-02: String-Based Foreign Keys (6 tests)"
          echo "  âœ“ RISK-03: Restaurant Availability Not Validated (7 tests)"
          echo "  âœ“ RISK-04: FoodItem Availability Not Validated (8 tests)"
          echo "  âœ“ RISK-05: Price Manipulation (8 tests)"
          echo "  âœ“ RISK-06: Payment-Order Status Sync Failure (7 tests)"

      - name: âŒ Integration Tests Failed
        if: failure()
        run: |
          echo "âŒ Restaurant service integration tests failed!"
          echo "Please check the logs above for details."
          exit 1

  payment-service-tests:
    name: Payment Service Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: Restaurant
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 40s

    strategy:
      matrix:
        node-version: [18.x]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          # Cache disabled for monorepo - npm ci is fast enough
          # cache: 'npm'
          # cache-dependency-path: 'backend/payment-service/package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        working-directory: ./backend/payment-service
        run: npm ci

      - name: â³ Wait for MongoDB to be Ready
        run: |
          echo "â³ Waiting for MongoDB to be ready..."
          sleep 5
          
          echo "ğŸ” Testing MongoDB connection..."
          node -e "
            const { MongoClient } = require('mongodb');
            const client = new MongoClient('mongodb://localhost:27017');
            client.connect()
              .then(() => {
                console.log('âœ… MongoDB connection successful!');
                return client.db('Restaurant').admin().ping();
              })
              .then(() => {
                console.log('âœ… MongoDB ping successful!');
                return client.close();
              })
              .catch(err => {
                console.error('âŒ MongoDB connection failed:', err.message);
                process.exit(1);
              });
          "
        working-directory: ./backend/payment-service

      - name: ğŸ§ª Run Payment Service Integration Tests
        working-directory: ./backend/payment-service
        env:
          MONGO_URI: mongodb://localhost:27017/Restaurant
          STRIPE_SECRET_KEY: sk_test_mock_key_for_testing
          STRIPE_WEBHOOK_SECRET: whsec_test_mock_webhook_secret
          JWT_SECRET: test_secret_key_for_integration_tests_ci_cd
          PORT: 5003
          NODE_ENV: test
        run: |
          echo "ğŸš€ Running Payment Service Integration Tests..."
          echo "Environment Configuration:"
          echo "  - MONGO_URI: $MONGO_URI"
          echo "  - PORT: $PORT"
          echo "  - NODE_ENV: $NODE_ENV"
          echo ""
          echo "âš ï¸ Note: Tests run serially with --runInBand to prevent database race conditions"
          echo ""
          npm run test:integration -- --verbose

      - name: ğŸ“Š Generate Test Report
        if: always()
        working-directory: ./backend/payment-service
        run: |
          echo "ğŸ“Š Payment Service Test Results Summary:"
          echo "========================================"
          echo "Tests completed. Check logs above for details."

      - name: ğŸ“ˆ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: payment-service-test-results-node-${{ matrix.node-version }}
          path: |
            backend/payment-service/coverage/
            backend/payment-service/*.log
          retention-days: 7

      - name: âœ… Payment Service Tests Summary
        if: success()
        run: |
          echo "âœ… All payment service integration tests passed successfully!"
          echo ""
          echo "ğŸ“‹ Security Risks Validated (51 tests):"
          echo "  âœ“ RISK-PAYMENT-01: Client Secret Leakage (6 tests)"
          echo "  âœ“ RISK-PAYMENT-02: Duplicate OrderId Race Conditions (8 tests)"
          echo "  âœ“ RISK-PAYMENT-03: Price Manipulation (10 tests)"
          echo "  âœ“ RISK-PAYMENT-04: Webhook Signature Verification (10 tests)"
          echo "  âœ“ RISK-PAYMENT-09: Sensitive Data Logging (10 tests)"
          echo "  âœ“ RISK-PAYMENT-10: No Idempotency Key (10 tests)"

      - name: âŒ Payment Service Tests Failed
        if: failure()
        run: |
          echo "âŒ Payment service integration tests failed!"
          echo "Please check the logs above for details."
          exit 1

  security-analysis:
    name: Security Risk Analysis
    runs-on: ubuntu-latest
    needs: [restaurant-service-tests, payment-service-tests]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Analyze Integration Test Results
        run: |
          echo "ğŸ”’ Security Risk Analysis Report"
          echo "=================================="
          echo ""
          echo "ğŸ“Œ Critical Risks Validated:"
          echo ""
          echo "ğŸ”´ HIGH PRIORITY - Restaurant Service:"
          echo "  â€¢ RISK-05: Price Manipulation (Client-Controlled Pricing)"
          echo "  â€¢ RISK-06: Payment-Order Status Sync Failure"
          echo "  â€¢ RISK-01: JWT Secret Mismatch Across Services"
          echo ""
          echo "ğŸ”´ HIGH PRIORITY - Payment Service:"
          echo "  â€¢ RISK-PAYMENT-01: Client Secret Leakage in Database"
          echo "  â€¢ RISK-PAYMENT-03: Price Manipulation via Client Amount"
          echo "  â€¢ RISK-PAYMENT-04: Webhook Signature Verification Bypass"
          echo "  â€¢ RISK-PAYMENT-10: Missing Idempotency Keys"
          echo ""
          echo "ğŸŸ¡ MEDIUM PRIORITY:"
          echo "  â€¢ RISK-03: Restaurant Availability Not Validated"
          echo "  â€¢ RISK-04: FoodItem Availability Not Validated"
          echo "  â€¢ RISK-PAYMENT-02: Duplicate OrderId Race Conditions"
          echo "  â€¢ RISK-PAYMENT-09: Sensitive Data in Logs"
          echo ""
          echo "ğŸŸ¢ LOW PRIORITY:"
          echo "  â€¢ RISK-02: String-Based Foreign Keys"
          echo ""
          echo "ğŸ’¡ Recommendation: Address HIGH priority risks immediately"
          echo ""
          echo "ğŸ“Š Total Tests Executed: 93 integration tests"
          echo "  - Restaurant Service: 42 tests"
          echo "  - Payment Service: 51 tests"

      - name: ğŸ“ Create Test Failure Summary
        if: needs.restaurant-service-tests.result == 'failure' || needs.payment-service-tests.result == 'failure'
        run: |
          echo "## ğŸš¨ Integration Test Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
          echo "One or more integration tests have failed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.restaurant-service-tests.result }}" == "failure" ]; then
            echo "- âŒ Restaurant Service Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.payment-service-tests.result }}" == "failure" ]; then
            echo "- âŒ Payment Service Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Action Required" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the workflow logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Investigate the failing test cases" >> $GITHUB_STEP_SUMMARY
          echo "3. Fix the issues in the codebase" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-run the tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "**Restaurant Service:**" >> $GITHUB_STEP_SUMMARY
          echo "- JWT Secret Mismatch" >> $GITHUB_STEP_SUMMARY
          echo "- String-Based Foreign Keys" >> $GITHUB_STEP_SUMMARY
          echo "- Restaurant Availability Validation" >> $GITHUB_STEP_SUMMARY
          echo "- FoodItem Availability Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Price Manipulation Prevention" >> $GITHUB_STEP_SUMMARY
          echo "- Payment-Order Status Synchronization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Payment Service:**" >> $GITHUB_STEP_SUMMARY
          echo "- Client Secret Leakage" >> $GITHUB_STEP_SUMMARY
          echo "- Duplicate OrderId Race Conditions" >> $GITHUB_STEP_SUMMARY
          echo "- Price Manipulation" >> $GITHUB_STEP_SUMMARY
          echo "- Webhook Signature Verification" >> $GITHUB_STEP_SUMMARY
          echo "- Sensitive Data Logging" >> $GITHUB_STEP_SUMMARY
          echo "- Missing Idempotency Keys" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Create Success Summary
        if: needs.restaurant-service-tests.result == 'success' && needs.payment-service-tests.result == 'success'
        run: |
          echo "## âœ… All Integration Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: 93 integration tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Restaurant Service (42 tests):" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-01: JWT Secret Mismatch (7 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-02: String-Based Foreign Keys (6 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-03: Restaurant Availability (7 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-04: FoodItem Availability (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-05: Price Manipulation (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-06: Payment-Order Status Sync (7 tests)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Payment Service (51 tests):" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-PAYMENT-01: Client Secret Leakage (6 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-PAYMENT-02: Duplicate OrderId Race (8 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-PAYMENT-03: Price Manipulation (10 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-PAYMENT-04: Webhook Signature (10 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-PAYMENT-09: Sensitive Logging (10 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RISK-PAYMENT-10: No Idempotency Key (10 tests)" >> $GITHUB_STEP_SUMMARY

  notification:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [restaurant-service-tests, payment-service-tests]
    if: always()
    
    steps:
      - name: âœ… Success Notification
        if: needs.restaurant-service-tests.result == 'success' && needs.payment-service-tests.result == 'success'
        run: |
          echo "âœ… All integration tests passed!"
          echo "   - Restaurant Service: 42 tests"
          echo "   - Payment Service: 51 tests"
          echo "ğŸ‰ Great job! The codebase maintains expected behavior for all known vulnerabilities."

      - name: âŒ Failure Notification
        if: needs.restaurant-service-tests.result == 'failure' || needs.payment-service-tests.result == 'failure'
        run: |
          echo "âŒ One or more integration test suites failed!"
          if [ "${{ needs.restaurant-service-tests.result }}" == "failure" ]; then
            echo "   - Restaurant Service: FAILED"
          fi
          if [ "${{ needs.payment-service-tests.result }}" == "failure" ]; then
            echo "   - Payment Service: FAILED"
          fi
          echo "ğŸ” Please review the test logs and fix the issues."
          echo "âš ï¸ This may indicate new changes that affect existing vulnerabilities."
